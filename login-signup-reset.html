<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Entrar | Hotel Fidelidade</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      background: var(--secondary, #fff);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-dark, #08162e);
    }
    .auth-container {
      width: 100%;
      max-width: 360px;
      box-shadow: 0 2px 18px var(--shadow, rgba(16,36,69,0.09));
      border-radius: var(--radius, 12px);
      background: #fff;
      padding: 32px 30px 18px 30px;
      display: flex;
      flex-direction: column;
      gap: 21px;
      align-items: center;
    }
    .auth-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    .auth-header svg {
      margin-bottom: 8px;
    }
    .auth-title {
      font-size: 1.34rem;
      font-weight: bold;
      color: var(--primary, #102445);
      letter-spacing: 0.01em;
    }
    .auth-tabs {
      display: flex;
      width: 100%;
    }
    .auth-tab {
      flex: 1;
      text-align: center;
      font-weight: 500;
      padding: 12px 0;
      background: none;
      border: none;
      color: var(--primary-light, #223b6f);
      cursor: pointer;
      font-size: 1.05rem;
      border-bottom: 2.7px solid transparent;
      transition: border-color .18s, color .18s;
      border-radius: 6px 6px 0 0;
    }
    .auth-tab.active {
      color: var(--primary, #102445);
      border-bottom: 2.7px solid var(--primary, #102445);
      background: #f6faff;
    }
    .auth-form {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-bottom: 14px;
    }
    .auth-form label {
      font-size: 0.99rem;
      font-weight: 500;
      margin-bottom: 4px;
      margin-left: 3px;
      color: var(--primary-light, #223b6f);
    }
    .auth-form input {
      width: 100%;
      font-size: 1.09rem;
      padding: 11px 12px;
      border: 1.35px solid var(--border, #dde6f1);
      background: #f7fafd;
      border-radius: 7px;
      margin-bottom: 3px;
      box-sizing: border-box;
      color: var(--primary-dark, #08162e);
      transition: border-color .13s;
      outline: none;
    }
    .auth-form input:focus {
      border-color: var(--primary, #102445);
    }
    .auth-actions {
      width: 100%;
      margin-top: 1px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: stretch;
    }
    .auth-btn {
      background: var(--primary, #102445);
      color: #fff;
      border: none;
      border-radius: var(--radius, 12px);
      padding: 12px 0 10px 0;
      font-size: 1.08rem;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 0;
      box-shadow: 0 2px 6px var(--shadow, rgba(16,36,69,0.07));
      transition: background .14s;
    }
    .auth-btn:hover:not([disabled]) {
      background: var(--primary-light, #223b6f);
    }

    .utils-row {
      width: 100%;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin: 7px 0 2px 0;
      font-size: 0.99rem;
    }
    .utils-link {
      color: var(--accent, #4db6ff);
      text-decoration: none;
      background: none;
      border: none;
      font: inherit;
      font-size: .96em;
      cursor: pointer;
      padding: 0;
      transition: color .12s;
    }
    .utils-link:hover {
      color: var(--primary-light, #223b6f);
      text-decoration: underline;
    }
    .auth-message {
      font-size: 0.99rem;
      margin-top: 2px;
      min-height: 28px;
      color: #b02e2e; /* error by default */
      text-align: center;
      line-height: 1.35;
    }
    .auth-message.success {
      color: #167053;
    }

    @media (max-width: 700px) {
      .auth-container { max-width: 98vw;}
      body { align-items: flex-start; justify-content: center;}
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="auth-header">
      <svg height="38" width="40" viewBox="0 0 40 38" fill="none" style="margin-bottom:0">
        <rect x="5" y="16" width="30" height="18" rx="4" fill="#223B6F"/>
        <rect x="13" y="4" width="14" height="12" rx="4" fill="#4db6ff"/>
        <circle cx="20" cy="21.5" r="1.7" fill="#fff"/>
        <polygon points="20,7 21.2,11.2 25.8,11.3 22.8,13.2 23.9,16.25 20,14.1 16.1,16.25 17.2,13.2 14.2,11.3 18.8,11.2" fill="#FFD700"/>
      </svg>
      <span class="auth-title">Hotel Fidelidade</span>
    </div>
    <div class="auth-tabs">
      <button id="tab-login" class="auth-tab active">Entrar</button>
      <button id="tab-signup" class="auth-tab">Cadastrar</button>
      <button id="tab-reset" class="auth-tab">Recuperar</button>
    </div>
    <!-- LOGIN FORM -->
    <form id="form-login" class="auth-form" autocomplete="on">
      <label for="login-email">E-mail</label>
      <input id="login-email" type="email" autocomplete="username" required />
      <label for="login-password">Senha</label>
      <input id="login-password" type="password" autocomplete="current-password" required />
      <div class="auth-actions">
        <button class="auth-btn" type="submit">Entrar</button>
        <div class="utils-row">
          <span></span>
          <button type="button" class="utils-link" id="to-reset1">Esqueci a senha</button>
        </div>
      </div>
      <div class="auth-message" id="msg-login"></div>
    </form>
    <!-- SIGNUP FORM -->
    <form id="form-signup" class="auth-form" autocomplete="on" style="display:none">
      <label for="signup-name">Nome</label>
      <input id="signup-name" type="text" autocomplete="name" required maxlength="60"/>
      <label for="signup-email">E-mail</label>
      <input id="signup-email" type="email" autocomplete="username" required/>
      <label for="signup-password">Senha</label>
      <input id="signup-password" type="password" autocomplete="new-password" required minlength="6" maxlength="50"/>
      <div class="auth-actions">
        <button class="auth-btn" type="submit">Cadastrar</button>
        <div class="utils-row">
          <span></span>
          <button type="button" class="utils-link" id="to-login1">Já tenho conta</button>
        </div>
      </div>
      <div class="auth-message" id="msg-signup"></div>
    </form>
    <!-- RESET FORM -->
    <form id="form-reset" class="auth-form" autocomplete="on" style="display:none">
      <label for="reset-email">E-mail</label>
      <input id="reset-email" type="email" autocomplete="username" required/>
      <div class="auth-actions">
        <button class="auth-btn" type="submit">Enviar link</button>
        <div class="utils-row">
          <button type="button" class="utils-link" id="to-login2">Entrar</button>
        </div>
      </div>
      <div class="auth-message" id="msg-reset"></div>
    </form>
  </div>
  <script type="importmap">
    {
      "imports": {
        "@supabase/supabase-js": "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"
      }
    }
  </script>
  <script type="module">
    import { createClient } from "@supabase/supabase-js";
    // Configure aqui:
    const SUPABASE_URL = "https://kpjwznuthdnodfqgnidk.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtwand6bnV0aGRub2RmcWduaWRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM4MDcxMjcsImV4cCI6MjA1OTM4MzEyN30.8rtnknzowlYM393S_awylDyKHBG9P3cI2VrKgQwxqNU";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // UI helpers
    const tabs = [
      { btn: document.getElementById('tab-login'), form: document.getElementById('form-login') },
      { btn: document.getElementById('tab-signup'), form: document.getElementById('form-signup') },
      { btn: document.getElementById('tab-reset'), form: document.getElementById('form-reset') },
    ];
    function showTab(idx) {
      tabs.forEach((tab, i) => {
        tab.btn.classList.toggle('active', i===idx);
        tab.form.style.display = (i===idx ? 'block' : 'none');
        if (i === idx) {
          // clear messages/input
          tab.form.querySelectorAll("input").forEach(inp => inp.value = inp.defaultValue);
          const msg = tab.form.querySelector('.auth-message');
          if (msg) { msg.textContent = ""; msg.classList.remove("success"); }
        }
      });
      // Focus
      setTimeout(() => {
        let input = tabs[idx].form.querySelector("input");
        if (input) input.focus();
      }, 80);
    }

    // tab clicks
    tabs[0].btn.onclick = () => showTab(0);
    tabs[1].btn.onclick = () => showTab(1);
    tabs[2].btn.onclick = () => showTab(2);

    document.getElementById('to-login1').onclick = () => showTab(0);
    document.getElementById('to-reset1').onclick = () => showTab(2);
    document.getElementById('to-login2').onclick = () => showTab(0);

    // Check if already logged in
    (async function(){
      try {
        let { data } = await supabase.auth.getSession();
        if (data.session?.user) location.href = "index.html";
      } catch {}
    })();

    // LOGIN
    document.getElementById("form-login").onsubmit = async e => {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const msgEl = document.getElementById('msg-login');
      msgEl.classList.remove('success');
      msgEl.textContent = "Entrando...";
      try {
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
          msgEl.textContent = traducaoErro(error);
        } else {
          msgEl.textContent = "Logado com sucesso!";
          msgEl.classList.add('success');
          setTimeout(() => location.href="index.html", 800);
        }
      } catch(err) {
        msgEl.textContent = "Erro ao autenticar. Tente novamente.";
      }
    };

    // SIGNUP
    document.getElementById("form-signup").onsubmit = async e => {
      e.preventDefault();
      const nome = document.getElementById('signup-name').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value.trim();
      const msgEl = document.getElementById('msg-signup');
      msgEl.classList.remove('success');
      msgEl.textContent = "Salvando...";
      try {
        // Cria usuário no auth
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) {
          msgEl.textContent = traducaoErro(error);
          return;
        }
        // Cria dados do usuário na tabela usuarios
        if (data.user) {
          await supabase.from("usuarios").insert({
            id: data.user.id, email: email, nome: nome, nivel: "Membro"
          });
        }
        msgEl.textContent = "Cadastro realizado! Confira seu e-mail para confirmar a conta.";
        msgEl.classList.add('success');
        setTimeout(() => showTab(0), 1500);
      } catch (err) {
        msgEl.textContent = "Erro ao cadastrar.";
      }
    };

    // RESET
    document.getElementById("form-reset").onsubmit = async e => {
      e.preventDefault();
      const email = document.getElementById('reset-email').value.trim();
      const msgEl = document.getElementById('msg-reset');
      msgEl.classList.remove('success');
      msgEl.textContent = "Enviando...";
      try {
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: location.origin + "/login-signup-reset.html"
        });
        if (error) {
          msgEl.textContent = traducaoErro(error);
        } else {
          msgEl.textContent = "E-mail de recuperação enviado! Siga o link para redefinir sua senha.";
          msgEl.classList.add('success');
        }
      } catch {
        msgEl.textContent = "Erro ao enviar e-mail de recuperação.";
      }
    };

    function traducaoErro(error) {
      if (!error) return "Ocorreu um erro.";
      if (typeof error === "string") return error;
      let msg = error.message || error.error_description || error.error;
      if (!msg) return "Ocorreu um erro.";
      msg = msg.replace(/email/i, "e-mail");
      if (/user already registered/i.test(msg)) return "E-mail já cadastrado.";
      if (/invalid login/i.test(msg) || /invalid credentials/i.test(msg)) return "E-mail ou senha inválidos.";
      if (/password/i.test(msg) && /short|too short|min 6/i.test(msg)) return "A senha deve ter pelo menos 6 caracteres.";
      if (/reset/i.test(msg)) return "Não foi possível enviar e-mail de recuperação.";
      return msg;
    }

    // Opção: Enter para envio, e mudar tab com links/atalhos
    window.addEventListener('keydown', e => {
      if (e.key === "Enter") {
        const form = tabs.find(t => t.form.style.display === "block" && t.form.contains(document.activeElement));
        if (form) {
          const submit = form.form.querySelector("button[type=submit]");
          if (submit) submit.blur();
        }
      }
    });

    // [Supabase reset password: se voltar com hash (ex: #access_token...), tenta novamente]
    if (location.hash.includes("type=recovery")) {
      showTab(0);
      document.getElementById('msg-login').textContent = "Senha redefinida, entre com sua nova senha.";
      document.getElementById('msg-login').classList.add('success');
    }

    // Por padrão: foca login
    showTab(0);
  </script>
</body>
</html>